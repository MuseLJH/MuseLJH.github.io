<!DOCTYPE html>



  

<script type="text/javascript" src="/lib/clipboard/clipboard.js"></script>
<script type="text/javascript" src="/js/src/custom.js"></script>
<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon-32x32-next.png?v=5.1.4" color="#222">





  <meta name="keywords" content="PHP内核分析,PHP弱类型,">





  <link rel="alternate" href="/atom.xml" title="LJH's blog" type="application/atom+xml">






<meta name="description" content="在CTF比赛中PHP弱类型的特性常常被用上，但我们往往知其然不知其所以然，究竟为什么PHP是弱类型呢？很少人深究。">
<meta name="keywords" content="PHP内核分析,PHP弱类型">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核">
<meta property="og:url" content="https://museljh.github.io/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/index.html">
<meta property="og:site_name" content="LJH&#39;s blog">
<meta property="og:description" content="在CTF比赛中PHP弱类型的特性常常被用上，但我们往往知其然不知其所以然，究竟为什么PHP是弱类型呢？很少人深究。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://museljh.github.io/images/fly.png">
<meta property="og:image" content="https://i.imgur.com/RuQpofN.png">
<meta property="og:image" content="https://i.imgur.com/EM4vsEN.png">
<meta property="og:image" content="https://i.imgur.com/gMWqzae.png">
<meta property="og:image" content="https://i.imgur.com/tFGcobN.png">
<meta property="og:image" content="https://i.imgur.com/4N2WHJq.png">
<meta property="og:image" content="https://i.imgur.com/AXhqNdV.png">
<meta property="og:image" content="https://i.imgur.com/9IXloG3.png">
<meta property="og:image" content="https://i.imgur.com/p6nTs1r.png">
<meta property="og:image" content="https://i.imgur.com/XVUpc3Q.png">
<meta property="og:image" content="https://i.imgur.com/2F2DLva.png">
<meta property="og:image" content="https://i.imgur.com/6isxsTs.png">
<meta property="og:image" content="https://i.imgur.com/gvfdjFW.png">
<meta property="og:image" content="https://i.imgur.com/tFiBazU.png">
<meta property="og:image" content="https://i.imgur.com/u0eHfcF.png">
<meta property="og:image" content="https://i.imgur.com/7LjAy1u.png">
<meta property="og:image" content="https://i.imgur.com/JOIPz8r.png">
<meta property="og:image" content="https://i.imgur.com/3J6lBoh.png">
<meta property="og:image" content="https://i.imgur.com/KqTZiGK.png">
<meta property="og:image" content="https://i.imgur.com/CvETlAa.png">
<meta property="og:image" content="https://i.imgur.com/q8PoRVR.png">
<meta property="og:image" content="https://i.imgur.com/oz6iVWs.png">
<meta property="og:image" content="https://i.imgur.com/Dkm5Ix6.png">
<meta property="og:image" content="https://i.imgur.com/hgjQdOQ.png">
<meta property="og:image" content="https://i.imgur.com/QOxDpIr.png">
<meta property="og:image" content="https://i.imgur.com/9q0v10w.png">
<meta property="og:image" content="https://i.imgur.com/NkRgIZm.png">
<meta property="og:updated_time" content="2019-03-04T15:03:56.759Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核">
<meta name="twitter:description" content="在CTF比赛中PHP弱类型的特性常常被用上，但我们往往知其然不知其所以然，究竟为什么PHP是弱类型呢？很少人深究。">
<meta name="twitter:image" content="https://museljh.github.io/images/fly.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://museljh.github.io/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/">





  <title>记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核 | LJH's blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

<a href="https://github.com/MuseLJH" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  <div class=" page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LJH's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">LJH's blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://museljh.github.io/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LJH">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJH's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-04T22:44:50+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/文章/" itemprop="url" rel="index">
                    <span itemprop="name">文章</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/" class="leancloud_visitors" data-flag-title="记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20
                </span>
              
            </div>
          

          
              <div class="post-description">
                  在CTF比赛中PHP弱类型的特性常常被用上，但我们往往知其然不知其所以然，究竟为什么PHP是弱类型呢？很少人深究。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/images/fly.png" alt=""></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在CTF比赛中PHP弱类型的特性常常被用上，但我们往往知其然不知其所以然，究竟为什么PHP是弱类型呢？很少人深究。在这次源码分析的过程中我收获很大，第一次学会了如何深入理解一个问题，虽然花费了我很多时间，但这可以说是一段非常值得的经历。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>首先引入一个问题，为什么以下结果是恒为真的呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump([]&gt;1);</span><br><span class="line">var_dump([]&gt;0);</span><br><span class="line">var_dump([]&gt;-1);</span><br></pre></td></tr></table></figure></p>
<p>当然实际ctf中问题可能会如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_GET[Password]&gt;99999;</span><br></pre></td></tr></table></figure></p>
<p>当传入Password[]=1<br>时侯恒为真<br>当然再换一种形式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump([[]]&gt;[1]);</span><br></pre></td></tr></table></figure></p>
<p>依旧是恒为真<br>对于这类问题，很多人都是认为PHP因为它是弱类型语言它就有这种特性<br>那么为什么PHP会有这种特性呢？<br>我们首先查阅下PHP手册<br><a href="http://php.net/manual/en/language.operators.comparison.php#language.operators.comparison.types" target="_blank" rel="noopener">Comparison Operators</a><br><img src="https://i.imgur.com/RuQpofN.png" alt=""><br>在手册中写到，当array和anything进行比较的时候array is always greater<br>这是一种PHP的定义。<br>那么究竟PHP到底在哪定义了这种特点呢？<br>我们依旧不知道。<br>我们再抛出个问题究竟什么是PHP弱类型呢？<br>很多人可能会回答弱类型就是弱类型，当传入Password[]=1就会绕过这就是弱类型<br>这种回答肯定是不妥当的<br>具体弱类型定义</p>
<blockquote>
<p>PHP是弱类型语言，不需要明确的定义变量的类型，变量的类型根据使用时的上下文所决定，也就是变量会根据不同表达式所需要的类型自动转换，比如求和，PHP会将两个相加的值转为long、double再进行加和。每种类型转为另外一种类型都有固定的规则，当某个操作发现类型不符时就会按照这个规则进行转换，这个规则正是弱类型实现的基础。</p>
</blockquote>
<p>我们再通过查阅PHP源码来深刻理解PHP弱类型的特点<br>PHP是开源的一种语言，我们在Github上可以很容易的查询到它的源码<br><a href="https://github.com/php/php-src/blob/master/Zend/zend_operators.h" target="_blank" rel="noopener">传送门</a><br>这里找函数会方便点<br>当然解释下什么是Zend</p>
<blockquote>
<p>Zend是PHP语言实现的最为重要的部分，是PHP最基础、最核心的部分，它的源码在/Zend目录下，PHP代码从编译到执行都是由Zend完成的</p>
</blockquote>
<p>至于为什么要查询zend_operators.h这个文件，operator操作符，其他几个文件不像存在比较函数，有的时候查源码时候就是需要靠感觉，这种大项目 函数变量什么的都有规范 一般所见即所得 看懂英语就大概猜得到用途的，<br>当然这个文件也不一般<br>我再进行解释下,当然想深入理解可以看<a href="http://wiki.jikexueyuan.com/project/extending-embedding-php/2.1.html" target="_blank" rel="noopener">这里</a></p>
<blockquote>
<p>PHP在内核中是通过zval这个结构体来存储变量的，它的定义在Zend/zend.h文件里，简短精炼，只有四个成员组成：</p>
</blockquote>
<p>我们定位到函数</p>
<blockquote>
<p>ZEND_API int ZEND_FASTCALL is_smaller_function(zval <em>result, zval </em>op1, zval *op2);</p>
</blockquote>
<p>这里传入了两个值op1,op2,传出一个result<br>解释下zval类型</p>
<blockquote>
<p>zval以一个P结尾的宏的参数大多是*zval型变量。 此外获取变量类型的宏还有两个，分别是Z_TYPE和Z_TYPE_PP，前者的参数是zval型，而后者的参数则是**zval。</p>
</blockquote>
<p>这样说可能会有些抽象<br>我们换种方式解释，当再php源码中要想判断一个变量的类型最直接的方式，比如想判断这个变量是否为空<br>变量-&gt;type == IS_NULL</p>
<p>这种方法虽然是正确的，但PHP官网并不建议这么做，PHP中定义了大量的宏，供我们检测、操作变量使用<br>解释下什么是宏</p>
<blockquote>
<p>C语言中允许用一个标识符来标识一个字符串，称为“宏”；标识符为“宏名”。在编译预处理时，对程序中所有出现的“宏名”，都用宏定义时的字符串去代换，简称“宏代换”或“宏展开”。一般形式：#define 宏名 字符串</p>
</blockquote>
<p>宏定义说明及注意：</p>
<blockquote>
<p>宏定义时用宏名来表示一个字符串，在宏展开时又以该字符串替换了宏名，这只是一个简单的替换；<br>宏定义不需要再行末加分号，若加上分号，则会连分号也会被替换的；<br>宏定义必须在函数外面；宏定义的作用域：从定义命令至程序结束，若想终止宏的作用域，则使用undef命令；<br>宏名在程序中用引号括起来，则预处理程序对其不进行宏替换；<br>宏定义是可以嵌套使用的，在展开时，由预处理程序层层替换；<br>建议在进行宏定义时，尽量使用大写字母表示宏名；<br>可用宏来表示数据类型，使书写方便；<br>对“输出格式”做用定义，可以减少书写麻烦。</p>
</blockquote>
<p>PHP建议使用的形式<br>Z_TYPE_P(变量) == IS_NULL</p>
<blockquote>
<p>以一个P结尾的宏的参数大多是*zval型变量。 此外获取变量类型的宏还有两个，分别是Z_TYPE和Z_TYPE_PP，前者的参数是zval型，而后者的参数则是**zval</p>
</blockquote>
<p>这样我们便可以猜测一下php内核是如何实现gettype这个函数了，代码如下：想要详细了解的可以看<a href="http://wiki.jikexueyuan.com/project/extending-embedding-php/2.1.html" target="_blank" rel="noopener">这里</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">//开始定义php语言中的函数gettype</span><br><span class="line">PHP_FUNCTION(gettype)</span><br><span class="line">&#123;</span><br><span class="line">    //arg间接指向调用gettype函数时所传递的参数。是一个zval**结构</span><br><span class="line">    //所以我们要对他使用__PP后缀的宏。</span><br><span class="line">    zval **arg;</span><br><span class="line"></span><br><span class="line">    //这个if的操作主要是让arg指向参数～</span><br><span class="line">    if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;Z&quot;, &amp;arg) == FAILURE) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //调用Z_TYPE_PP宏来获取arg指向zval的类型。</span><br><span class="line">    //然后是一个switch结构，RETVAL_STRING宏代表这gettype函数返回的字符串类型的值</span><br><span class="line">    switch (Z_TYPE_PP(arg)) &#123;</span><br><span class="line">        case IS_NULL:</span><br><span class="line">            RETVAL_STRING(&quot;NULL&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_BOOL:</span><br><span class="line">            RETVAL_STRING(&quot;boolean&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_LONG:</span><br><span class="line">            RETVAL_STRING(&quot;integer&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_DOUBLE:</span><br><span class="line">            RETVAL_STRING(&quot;double&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_STRING:</span><br><span class="line">            RETVAL_STRING(&quot;string&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_ARRAY:</span><br><span class="line">            RETVAL_STRING(&quot;array&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_OBJECT:</span><br><span class="line">            RETVAL_STRING(&quot;object&quot;, 1);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case IS_RESOURCE:</span><br><span class="line">            &#123;</span><br><span class="line">                char *type_name;</span><br><span class="line">                type_name = zend_rsrc_list_get_rsrc_type(Z_LVAL_PP(arg) TSRMLS_CC);</span><br><span class="line">                if (type_name) &#123;</span><br><span class="line">                    RETVAL_STRING(&quot;resource&quot;, 1);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            RETVAL_STRING(&quot;unknown type&quot;, 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上三个宏的定义在Zend/zend_operators.h里，定义分别是：</p>
<blockquote>
<p>#define Z_TYPE(zval)        (zval).type</p>
</blockquote>
<p>#define Z_TYPE_P(zval_p)    Z_TYPE(*zval_p)</p>
<p>#define Z_TYPE_PP(zval_pp)  Z_TYPE(**zval_pp)</p>
<p>这也是为是什么在Zend/zend_operators.h里面进行查询的原因，貌似有些跑题了？</p>
<p>当然下一个问题，为什么我们要定位到函数is_smaller_function<br>这里主要是靠对于PHP源码的熟悉，进行猜测，当然有的时候分析源码的时候可以讲PHP源码下载下载，部分IDE会有提供函数来源的功能<br>其实本来有个</p>
<blockquote>
<p>   lxr.php.net</p>
</blockquote>
<p>可以让我们迅速定位到我们想要的函数，但是这个网站在16年后就不是很稳定了，甚至有人将它当做一个BUG提交给PHP官网，这是一个很有趣的事情，具体可以了解<a href="https://bugs.php.net/bug.php?id=72396" target="_blank" rel="noopener">这里</a><br>那么我们还有没有什么办法迅速定位到我们需要的函数呢？</p>
<p>进入is_smaller_function的函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API int ZEND_FASTCALL is_smaller_function(zval *result, zval *op1, zval *op2) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	if (compare_function(result, op1, op2) == FAILURE) &#123;</span><br><span class="line">		return FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line">	ZVAL_BOOL(result, (Z_LVAL_P(result) &lt; 0));</span><br><span class="line">	return SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里有一个compare_function函数以及<br>ZVAL_BOOL<br>我们先分析下compare_function函数<br>跟进<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API int ZEND_FASTCALL compare_function(zval *result, zval *op1, zval *op2) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	int ret;</span><br><span class="line">	int converted = 0;</span><br><span class="line">	zval op1_copy, op2_copy;</span><br><span class="line">	zval *op_free, tmp_free;</span><br><span class="line"></span><br><span class="line">	while (1) &#123;</span><br><span class="line">		switch (TYPE_PAIR(Z_TYPE_P(op1), Z_TYPE_P(op2))) &#123;</span><br><span class="line">			case TYPE_PAIR(IS_LONG, IS_LONG):</span><br><span class="line">				ZVAL_LONG(result, Z_LVAL_P(op1)&gt;Z_LVAL_P(op2)?1:(Z_LVAL_P(op1)&lt;Z_LVAL_P(op2)?-1:0));</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_DOUBLE, IS_LONG):</span><br><span class="line">				Z_DVAL_P(result) = Z_DVAL_P(op1) - (double)Z_LVAL_P(op2);</span><br><span class="line">				ZVAL_LONG(result, ZEND_NORMALIZE_BOOL(Z_DVAL_P(result)));</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_LONG, IS_DOUBLE):</span><br><span class="line">				Z_DVAL_P(result) = (double)Z_LVAL_P(op1) - Z_DVAL_P(op2);</span><br><span class="line">				ZVAL_LONG(result, ZEND_NORMALIZE_BOOL(Z_DVAL_P(result)));</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_DOUBLE, IS_DOUBLE):</span><br><span class="line">				if (Z_DVAL_P(op1) == Z_DVAL_P(op2)) &#123;</span><br><span class="line">					ZVAL_LONG(result, 0);</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					Z_DVAL_P(result) = Z_DVAL_P(op1) - Z_DVAL_P(op2);</span><br><span class="line">					ZVAL_LONG(result, ZEND_NORMALIZE_BOOL(Z_DVAL_P(result)));</span><br><span class="line">				&#125;</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_ARRAY, IS_ARRAY):</span><br><span class="line">				ZVAL_LONG(result, zend_compare_arrays(op1, op2));</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_NULL, IS_NULL):</span><br><span class="line">			case TYPE_PAIR(IS_NULL, IS_FALSE):</span><br><span class="line">			case TYPE_PAIR(IS_FALSE, IS_NULL):</span><br><span class="line">			case TYPE_PAIR(IS_FALSE, IS_FALSE):</span><br><span class="line">			case TYPE_PAIR(IS_TRUE, IS_TRUE):</span><br><span class="line">				ZVAL_LONG(result, 0);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_NULL, IS_TRUE):</span><br><span class="line">				ZVAL_LONG(result, -1);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_TRUE, IS_NULL):</span><br><span class="line">				ZVAL_LONG(result, 1);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_STRING, IS_STRING):</span><br><span class="line">				if (Z_STR_P(op1) == Z_STR_P(op2)) &#123;</span><br><span class="line">					ZVAL_LONG(result, 0);</span><br><span class="line">					return SUCCESS;</span><br><span class="line">				&#125;</span><br><span class="line">				ZVAL_LONG(result, zendi_smart_strcmp(Z_STR_P(op1), Z_STR_P(op2)));</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_NULL, IS_STRING):</span><br><span class="line">				ZVAL_LONG(result, Z_STRLEN_P(op2) == 0 ? 0 : -1);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_STRING, IS_NULL):</span><br><span class="line">				ZVAL_LONG(result, Z_STRLEN_P(op1) == 0 ? 0 : 1);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_OBJECT, IS_NULL):</span><br><span class="line">				ZVAL_LONG(result, 1);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			case TYPE_PAIR(IS_NULL, IS_OBJECT):</span><br><span class="line">				ZVAL_LONG(result, -1);</span><br><span class="line">				return SUCCESS;</span><br><span class="line"></span><br><span class="line">			default:</span><br><span class="line">				if (Z_ISREF_P(op1)) &#123;</span><br><span class="line">					op1 = Z_REFVAL_P(op1);</span><br><span class="line">					continue;</span><br><span class="line">				&#125; else if (Z_ISREF_P(op2)) &#123;</span><br><span class="line">					op2 = Z_REFVAL_P(op2);</span><br><span class="line">					continue;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				if (Z_TYPE_P(op1) == IS_OBJECT &amp;&amp; Z_OBJ_HANDLER_P(op1, compare)) &#123;</span><br><span class="line">					ret = Z_OBJ_HANDLER_P(op1, compare)(result, op1, op2);</span><br><span class="line">					if (UNEXPECTED(Z_TYPE_P(result) != IS_LONG)) &#123;</span><br><span class="line">						convert_compare_result_to_long(result);</span><br><span class="line">					&#125;</span><br><span class="line">					return ret;</span><br><span class="line">				&#125; else if (Z_TYPE_P(op2) == IS_OBJECT &amp;&amp; Z_OBJ_HANDLER_P(op2, compare)) &#123;</span><br><span class="line">					ret = Z_OBJ_HANDLER_P(op2, compare)(result, op1, op2);</span><br><span class="line">					if (UNEXPECTED(Z_TYPE_P(result) != IS_LONG)) &#123;</span><br><span class="line">						convert_compare_result_to_long(result);</span><br><span class="line">					&#125;</span><br><span class="line">					return ret;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				if (Z_TYPE_P(op1) == IS_OBJECT &amp;&amp; Z_TYPE_P(op2) == IS_OBJECT) &#123;</span><br><span class="line">					if (Z_OBJ_P(op1) == Z_OBJ_P(op2)) &#123;</span><br><span class="line">						/* object handles are identical, apparently this is the same object */</span><br><span class="line">						ZVAL_LONG(result, 0);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125;</span><br><span class="line">					if (Z_OBJ_HANDLER_P(op1, compare_objects) == Z_OBJ_HANDLER_P(op2, compare_objects)) &#123;</span><br><span class="line">						ZVAL_LONG(result, Z_OBJ_HANDLER_P(op1, compare_objects)(op1, op2));</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (Z_TYPE_P(op1) == IS_OBJECT) &#123;</span><br><span class="line">					if (Z_OBJ_HT_P(op1)-&gt;get) &#123;</span><br><span class="line">						zval rv;</span><br><span class="line">						op_free = Z_OBJ_HT_P(op1)-&gt;get(Z_OBJ_P(op1), &amp;rv);</span><br><span class="line">						ret = compare_function(result, op_free, op2);</span><br><span class="line">						zend_free_obj_get_result(op_free);</span><br><span class="line">						return ret;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op2) != IS_OBJECT &amp;&amp; Z_OBJ_HT_P(op1)-&gt;cast_object) &#123;</span><br><span class="line">						ZVAL_UNDEF(&amp;tmp_free);</span><br><span class="line">						if (Z_OBJ_HT_P(op1)-&gt;cast_object(Z_OBJ_P(op1), &amp;tmp_free, ((Z_TYPE_P(op2) == IS_FALSE || Z_TYPE_P(op2) == IS_TRUE) ? _IS_BOOL : Z_TYPE_P(op2))) == FAILURE) &#123;</span><br><span class="line">							ZVAL_LONG(result, 1);</span><br><span class="line">							zend_free_obj_get_result(&amp;tmp_free);</span><br><span class="line">							return SUCCESS;</span><br><span class="line">						&#125;</span><br><span class="line">						ret = compare_function(result, &amp;tmp_free, op2);</span><br><span class="line">						zend_free_obj_get_result(&amp;tmp_free);</span><br><span class="line">						return ret;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (Z_TYPE_P(op2) == IS_OBJECT) &#123;</span><br><span class="line">					if (Z_OBJ_HT_P(op2)-&gt;get) &#123;</span><br><span class="line">						zval rv;</span><br><span class="line">						op_free = Z_OBJ_HT_P(op2)-&gt;get(Z_OBJ_P(op2), &amp;rv);</span><br><span class="line">						ret = compare_function(result, op1, op_free);</span><br><span class="line">						zend_free_obj_get_result(op_free);</span><br><span class="line">						return ret;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op1) != IS_OBJECT &amp;&amp; Z_OBJ_HT_P(op2)-&gt;cast_object) &#123;</span><br><span class="line">						ZVAL_UNDEF(&amp;tmp_free);</span><br><span class="line">						if (Z_OBJ_HT_P(op2)-&gt;cast_object(Z_OBJ_P(op2), &amp;tmp_free, ((Z_TYPE_P(op1) == IS_FALSE || Z_TYPE_P(op1) == IS_TRUE) ? _IS_BOOL : Z_TYPE_P(op1))) == FAILURE) &#123;</span><br><span class="line">							ZVAL_LONG(result, -1);</span><br><span class="line">							zend_free_obj_get_result(&amp;tmp_free);</span><br><span class="line">							return SUCCESS;</span><br><span class="line">						&#125;</span><br><span class="line">						ret = compare_function(result, op1, &amp;tmp_free);</span><br><span class="line">						zend_free_obj_get_result(&amp;tmp_free);</span><br><span class="line">						return ret;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op1) == IS_OBJECT) &#123;</span><br><span class="line">						ZVAL_LONG(result, 1);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (!converted) &#123;</span><br><span class="line">					if (Z_TYPE_P(op1) &lt; IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op2) ? -1 : 0);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op1) == IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op2) ? 0 : 1);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op2) &lt; IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op1) ? 1 : 0);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op2) == IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op1) ? 0 : -1);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						op1 = zendi_convert_scalar_to_number(op1, &amp;op1_copy, result, 1);</span><br><span class="line">						op2 = zendi_convert_scalar_to_number(op2, &amp;op2_copy, result, 1);</span><br><span class="line">						if (EG(exception)) &#123;</span><br><span class="line">							if (result != op1) &#123;</span><br><span class="line">								ZVAL_UNDEF(result);</span><br><span class="line">							&#125;</span><br><span class="line">							return FAILURE;</span><br><span class="line">						&#125;</span><br><span class="line">						converted = 1;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; else if (Z_TYPE_P(op1)==IS_ARRAY) &#123;</span><br><span class="line">					ZVAL_LONG(result, 1);</span><br><span class="line">					return SUCCESS;</span><br><span class="line">				&#125; else if (Z_TYPE_P(op2)==IS_ARRAY) &#123;</span><br><span class="line">					ZVAL_LONG(result, -1);</span><br><span class="line">					return SUCCESS;</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					ZEND_ASSERT(0);</span><br><span class="line">					zend_throw_error(NULL, &quot;Unsupported operand types&quot;);</span><br><span class="line">					if (result != op1) &#123;</span><br><span class="line">						ZVAL_UNDEF(result);</span><br><span class="line">					&#125;</span><br><span class="line">					return FAILURE;</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br></pre></td></tr></table></figure></p>
<p>有点长，想要仔细了解的可以详细看<br>讲解下<br>首先<br><img src="https://i.imgur.com/EM4vsEN.png" alt=""><br>这个先等下说<br><img src="https://i.imgur.com/gMWqzae.png" alt=""><br>这里进行swich 判断op1 与 op2 的类型<br>这里我们先拿第一句进行分析<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">case TYPE_PAIR(IS_LONG, IS_LONG):</span><br><span class="line">	ZVAL_LONG(result, Z_LVAL_P(op1)&gt;Z_LVAL_P(op2)?1:(Z_LVAL_P(op1)&lt;Z_LVAL_P(op2)?-1:0));</span><br><span class="line">	return SUCCESS;</span><br></pre></td></tr></table></figure></p>
<p>这里op1与op2都是IS_LONG类型<br>PHP中一共如下八种数据类型，具体想了解可以点<a href="http://wiki.jikexueyuan.com/project/extending-embedding-php/2.1.html" target="_blank" rel="noopener"></a><br><img src="https://i.imgur.com/tFGcobN.png" alt=""><br><img src="https://i.imgur.com/4N2WHJq.png" alt=""><br>所以IS_LONG是一种PHP种的整型。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZVAL_LONG(result, Z_LVAL_P(op1)&gt;Z_LVAL_P(op2)?1:(Z_LVAL_P(op1)&lt;Z_LVAL_P(op2)?-1:0));</span><br></pre></td></tr></table></figure></p>
<p>这句的意思是进行比较OP1，OP2的大小分别返回-1，0，1到result，<br><img src="https://i.imgur.com/AXhqNdV.png" alt=""><br>这里的result是有作用的，<br><img src="https://i.imgur.com/9IXloG3.png" alt=""><br>这里有一个ZVAL_BOOL函数进行判断，用于设置布尔值的zval ，ZVAL_BOOL就是定义这个zval的类型为bool。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define ZVAL_BOOL(z, b) do &#123;            \</span><br><span class="line">        Z_TYPE_INFO_P(z) =              \</span><br><span class="line">            (b) ? IS_TRUE : IS_FALSE;   \</span><br><span class="line">    &#125; while (0)</span><br></pre></td></tr></table></figure></p>
<p>换成当前的场景<br>result为z ，(Z_LVAL_P(result) &lt; 0)为b<br>z 为用于设置布尔值的zval<br>b 为 设置的布尔值</p>
<p><img src="https://i.imgur.com/p6nTs1r.png" alt=""></p>
<p>这个函数 名是is_smaller_function具体意思已经很明显了</p>
<p>只有 Z_LVAL_P(result) &lt; 0，当result=-1<br>（即op1&lt;op2的时候 result才为-1）<br>才会使b=1 并且使得<br>(b) ? IS_TRUE : IS_FALSE; 判断为IS_TRUE<br>并使得Z_TYPE_INFO_P(result) 为IS_TRUE，<br>最后就是根据Z_TYPE_INFO_P(result) 使IS_TRUE或者IS_FALSE来判断究竟是否小于</p>
<p>下一句<br><img src="https://i.imgur.com/XVUpc3Q.png" alt=""></p>
<p>因为两个值是可以进行比较的它会return SUCCESS，我是这么理解的<br><img src="https://i.imgur.com/2F2DLva.png" alt=""></p>
<p>如果有人看到这里，对于PHP究竟是如何判断大小应该有了基本的认识了吧<br>回到我们最开始的问题<br><img src="https://i.imgur.com/6isxsTs.png" alt=""><br>那么我们就应该取寻找OP1与OP2分别为array类型与IS_LONG的case<br>与OP1与OP2分别为array类型与array类型<br>当然阅读这些case的时候又冒出了个问题<br><img src="https://i.imgur.com/gvfdjFW.png" alt=""><br>这个又是什么意思呢？<br>经过查询我们可以知道这句话来源于<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define Z_ISREF(zval) (Z_TYPE(zval) == IS_REFERENCE)</span><br></pre></td></tr></table></figure></p>
<p>其意思为<br>该zval检查它是否是一个引用类型，姑且认为是判断这个变量是否属于PHP八种变量中的一种，<br>那么IS_REFERENCE又是什么呢</p>
<blockquote>
<p>此类型用于表示a zval是PHP引用。引用的值zval需要首先解除引用才能使用它。这可以使用ZVAL_DEREF或Z_REF宏来完成。zval可以检查A 以查看它是否是Z_ISREF宏的引用。</p>
</blockquote>
<p>姑且认为这个意思是zaval确实是PHP引用的变量之一</p>
<p>那么整句话的我的理解是，当发生default:的时候假如OP1,OP2是PHP引用变量之一那么就继续<br>接下来的几个case都不属于我们想要的情况<br>直到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">if (!converted) &#123;</span><br><span class="line">					if (Z_TYPE_P(op1) &lt; IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op2) ? -1 : 0);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op1) == IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op2) ? 0 : 1);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op2) &lt; IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op1) ? 1 : 0);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else if (Z_TYPE_P(op2) == IS_TRUE) &#123;</span><br><span class="line">						ZVAL_LONG(result, zval_is_true(op1) ? 0 : -1);</span><br><span class="line">						return SUCCESS;</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						op1 = zendi_convert_scalar_to_number(op1, &amp;op1_copy, result, 1);</span><br><span class="line">						op2 = zendi_convert_scalar_to_number(op2, &amp;op2_copy, result, 1);</span><br><span class="line">						if (EG(exception)) &#123;</span><br><span class="line">							if (result != op1) &#123;</span><br><span class="line">								ZVAL_UNDEF(result);</span><br><span class="line">							&#125;</span><br><span class="line">							return FAILURE;</span><br><span class="line">						&#125;</span><br><span class="line">						converted = 1;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; else if (Z_TYPE_P(op1)==IS_ARRAY) &#123;</span><br><span class="line">					ZVAL_LONG(result, 1);</span><br><span class="line">					return SUCCESS;</span><br><span class="line">				&#125; else if (Z_TYPE_P(op2)==IS_ARRAY) &#123;</span><br><span class="line">					ZVAL_LONG(result, -1);</span><br><span class="line">					return SUCCESS;</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					ZEND_ASSERT(0);</span><br><span class="line">					zend_throw_error(NULL, &quot;Unsupported operand types&quot;);</span><br><span class="line">					if (result != op1) &#123;</span><br><span class="line">						ZVAL_UNDEF(result);</span><br><span class="line">					&#125;</span><br><span class="line">					return FAILURE;</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为在函数的开头converted=0<br>所以!converted=1是正确的，<br>我们跟进这个判断<br>发现<br><img src="https://i.imgur.com/tFiBazU.png" alt=""><br>这边只要op1为IS_ARRAY类型的变量就result直接就为1了<br>这也解释了我们之前的问题<br><img src="https://i.imgur.com/u0eHfcF.png" alt=""><br>为什么[]无论是比较1，0，-1都是返回true<br>以及PHP手册中<br><img src="https://i.imgur.com/7LjAy1u.png" alt=""><br>中的这个问题</p>
<p>当然我们依旧留存下一个问题<br><img src="https://i.imgur.com/JOIPz8r.png" alt=""><br>为什么这个也是恒真的呢？<br>可以清楚看到左右两边都是数组，我们需要找到arrary与arrary的这种case<br><img src="https://i.imgur.com/3J6lBoh.png" alt=""><br>在最开始没几行就可以找到了<br>这里有一个函数zend_compare_arrays<br>我们跟进一下<br><img src="https://i.imgur.com/KqTZiGK.png" alt=""><br>我们可以看到它返回了一个zend_compare_symbol_tables函数<br>我们再跟进下<br><img src="https://i.imgur.com/CvETlAa.png" alt=""><br>当然在传入参数的时候又经历了Z_ARRVAL_P(a1)的变化<br>Z_ARRVAL_P(a1)源自</p>
<blockquote>
<p>#define Z_ARRVAL(zval) Z_ARR(zval)</p>
</blockquote>
<p>大概的含义是从数组中抓取hash值，<br><img src="https://i.imgur.com/q8PoRVR.png" alt=""><br>这里需要传入HashTable *ht1<br>那么HashTable 又是什么呢？</p>
<blockquote>
<p>在学数据结构的时候我们都有学到hash，<br>其实对于hashtable我之前的印象是比如python中的字典它的原理就是采取hash表，即采取键值对的方式进行查询数据，比起链表等方式查询无疑是要快的多</p>
</blockquote>
<p>那么这里的hashtable又是否和我想的一样呢？具体看<a href="http://www.php-internals.com/book/?p=chapt03/03-01-02-hashtable-in-php" target="_blank" rel="noopener">这里</a></p>
<blockquote>
<p>PHP内核中的哈希表是十分重要的数据结构，PHP的大部分的语言特性都是基于哈希表实现的， 例如：变量的作用域、函数表、类的属性、方法等，Zend引擎内部的很多数据都是保存在哈希表中的。</p>
</blockquote>
<blockquote>
<p>PHP中的哈希表实现在Zend/zend_hash.c中，先看看PHP实现中的数据结构， PHP使用如下两个数据结构来实现哈希表，HashTable结构体用于保存整个哈希表需要的基本信息， 而Bucket结构体用于保存具体的数据内容，如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _hashtable &#123; </span><br><span class="line">    uint nTableSize;        // hash Bucket的大小，最小为8，以2x增长。</span><br><span class="line">    uint nTableMask;        // nTableSize-1 ， 索引取值的优化</span><br><span class="line">    uint nNumOfElements;    // hash Bucket中当前存在的元素个数，count()函数会直接返回此值 </span><br><span class="line">    ulong nNextFreeElement; // 下一个数字索引的位置</span><br><span class="line">    Bucket *pInternalPointer;   // 当前遍历的指针（foreach比for快的原因之一）</span><br><span class="line">    Bucket *pListHead;          // 存储数组头元素指针</span><br><span class="line">    Bucket *pListTail;          // 存储数组尾元素指针</span><br><span class="line">    Bucket **arBuckets;         // 存储hash数组</span><br><span class="line">    dtor_func_t pDestructor;    // 在删除元素时执行的回调函数，用于资源的释放</span><br><span class="line">    zend_bool persistent;       //指出了Bucket内存分配的方式。如果persisient为TRUE，则使用操作系统本身的内存分配函数为Bucket分配内存，否则使用PHP的内存分配函数。</span><br><span class="line">    unsigned char nApplyCount; // 标记当前hash Bucket被递归访问的次数（防止多次递归）</span><br><span class="line">    zend_bool bApplyProtection;// 标记当前hash桶允许不允许多次访问，不允许时，最多只能递归3次</span><br><span class="line">#if ZEND_DEBUG</span><br><span class="line">    int inconsistent;</span><br><span class="line">#endif</span><br><span class="line">&#125; HashTable;</span><br></pre></td></tr></table></figure>
<p>当然如果要详细讲PHP中的hashtable讲清楚肯定要再写另一篇博客，这里我们就只讲这里所需要的原理<br><img src="https://i.imgur.com/oz6iVWs.png" alt=""><br>这里进行两个参数的判断，当两个参数hash值相等时候就返回0<br>我们可以直接看看php数组的hash，具体点<a href="https://www.jianshu.com/p/3f1d0f9907a1" target="_blank" rel="noopener">这里</a><br><img src="https://i.imgur.com/Dkm5Ix6.png" alt=""><br>这是在PHP5.6的数组结构<br>我们可以看到，数组本质就是一个hashtable结构，左侧的0~nTablemask便是hash下标，而后面有一个双向链表，便是我们通常所说的hash冲突的链地址法。<br><img src="https://i.imgur.com/hgjQdOQ.png" alt=""><br>这是PHP7.0的数组结构<br><img src="https://i.imgur.com/QOxDpIr.png" alt=""><br>Bucket结构便是我们所说的保存插入数据的结构。主要包括：key(字符串，如果是数字下标，转化位字符串), value, h(只会计算一次，如果是数组下标，直接把key作为h)。</p>
<p>稍稍回到原题，我们进行比较的就是Bucket结构中的hash值</p>
<p>那么hash值是怎么比较的呢？<br>我们查找zend_hash_compare函数到底是什么意思</p>
<blockquote>
<p>int zend_hash_compare(<br>    HashTable <em>ht1, HashTable </em>ht2, compare_func_t compar, zend_bool ordered TSRMLS_DC<br>);</p>
</blockquote>
<p>我们查询了hashtable的api具体想了解可以看<a href="http://www.phpinternalsbook.com/hashtables/hashtable_api.html" target="_blank" rel="noopener">这里</a><br>这里有一句话</p>
<blockquote>
<p>The return has the same meaning as compare_func_t. The function first compares the length of the arrays. If they differ, then the array with the larger length is considered greater. What happens when the length is the same depends on the ordered parameter:<br>For ordered=0 (not taking order into account) the function will walk through the buckets of the first hashtable and always look up if the second hashtable has an element with the same key. If it doesn’t, then the first hashtable is considered greater. If it does, then the compar function is invoked on the values.<br>For ordered=1 (taking order into account) both hashtables will be walked simultaneously. For each element first the key is compared and if it matches the value is compared using compar.<br>This is continued until either one of the comparisons returns a non-zero value (in which case the result of the comparison will also be the result of zend_hash_compare()) or until no more elements are available. In the latter case the hashtables are considered equal.</p>
</blockquote>
<p>解释一下<br>这里先会判断这两个数组参数的长度。如果它们不同，则认为具有较大长度的阵列更大<br>这也就能说明为什么我们前面的问题是恒真了吧<br><img src="https://i.imgur.com/9q0v10w.png" alt=""></p>
<p>当然当长度相同比如[7],与[6]<br><img src="https://i.imgur.com/NkRgIZm.png" alt=""><br>会遍历第一个数组，假如第一个数组的元素，并始终查找第二个哈希表是否具有相同键的元素。如果没有，那么第一个哈希表被认为更大，<br>看到这里大家的疑惑都解决了吧</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>通过这次探寻，我深刻发现到往往很多我们认为是常识的东西都有着很多极其复杂的原理，我们认识一件事物的时候不能仅仅只凭借表面现象就根据自己直觉来得出结论，虽然有的时候得出的结果是一样的，但是我们并不能够真正理解这个结论到底为何而来。</p>
<h2 id="转载"><a href="#转载" class="headerlink" title="转载"></a>转载</h2><p>本文由安全客原创发布<br>转载，请参考转载声明，注明出处： <a href="https://www.anquanke.com/post/id/171966" target="_blank" rel="noopener">https://www.anquanke.com/post/id/171966</a><br>安全客 - 有思想的安全新媒体</p>

      
    </div>
    
    
    
    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/">记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 LJH 的个人博客">LJH</a></p>
  <p><span>发布时间:</span>2019年03月04日 - 22:44</p>
  <p><span>最后更新:</span>2019年03月04日 - 23:03</p>
  <p><span>原始链接:</span><a href="/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/" title="记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核">https://museljh.github.io/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://museljh.github.io/2019/03/04/记一次深入理解PHP弱类型原理的经历并以此第一次深入了解PHP内核/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>


      
    </div>
    <div>
     
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------END-------------</div>
    
</div>

      
    </div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP内核分析/" rel="tag"><i class="fa fa-tag"></i> PHP内核分析</a>
          
            <a href="/tags/PHP弱类型/" rel="tag"><i class="fa fa-tag"></i> PHP弱类型</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/26/对于XXE漏洞的学习与实验复现记录（转载）/" rel="next" title="对于XXE漏洞的学习与实验复现记录（转载）">
                <i class="fa fa-chevron-left"></i> 对于XXE漏洞的学习与实验复现记录（转载）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/06/探索xss中的编码原理/" rel="prev" title="探索xss中的编码原理">
                探索xss中的编码原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MjUxOC8xOTA2NQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="LJH">
            
              <p class="site-author-name" itemprop="name">LJH</p>
              <p class="site-description motion-element" itemprop="description">无</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/MuseLJH" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1049135835@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/MuseLJHX" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#正文"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">3.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#转载"><span class="nav-number">4.</span> <span class="nav-text">转载</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'true') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("otYDWvApXTYxWRiyvbntKaiI-gzGzoHsz#<app_id>", "BGOUX1v4oeMfXIDWyV4dxdUt#<app_key>");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>